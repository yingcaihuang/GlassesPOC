# ğŸ‰ éŸ³é¢‘æ’­æ”¾é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š

## é—®é¢˜è¯Šæ–­

### åŸå§‹é—®é¢˜
ç”¨æˆ·æŠ¥å‘Šåœ¨ `http://localhost:3000/realtime-chat` ç•Œé¢ä¸­å‡ºç°éŸ³é¢‘è§£ç é”™è¯¯ï¼š
```
Audio decode error: EncodingError: Unable to decode audio data
```

### æ ¹æœ¬åŸå› 
å‰ç«¯çš„ `handleAudioPlayback` å‡½æ•°é”™è¯¯åœ°å°è¯•ä½¿ç”¨ `audioContext.decodeAudioData()` æ¥è§£ç GPTçš„éŸ³é¢‘å“åº”ã€‚ä½†æ˜¯GPT Realtime APIè¿”å›çš„æ˜¯**PCM16æ ¼å¼çš„åŸå§‹éŸ³é¢‘æ•°æ®**ï¼Œä¸æ˜¯éœ€è¦è§£ç çš„ç¼–ç éŸ³é¢‘æ ¼å¼ï¼ˆå¦‚MP3ã€WAVç­‰ï¼‰ã€‚

## æŠ€æœ¯ä¿®å¤

### ä¿®å¤å‰çš„é”™è¯¯ä»£ç 
```javascript
// é”™è¯¯ï¼šå°è¯•è§£ç PCM16æ•°æ®
const audioBuffer = await audioContext.decodeAudioData(arrayBuffer)
```

### ä¿®å¤åçš„æ­£ç¡®ä»£ç 
```javascript
// æ­£ç¡®ï¼šç›´æ¥å¤„ç†PCM16æ•°æ®
const audioContext = new (window.AudioContext || window.webkitAudioContext)({
  sampleRate: 24000 // GPTä½¿ç”¨24kHz
})

// å°†PCM16å­—èŠ‚è½¬æ¢ä¸ºFloat32æ ·æœ¬
const pcm16Data = new Int16Array(arrayBuffer)
const sampleCount = pcm16Data.length
const audioBuffer = audioContext.createBuffer(1, sampleCount, 24000) // å•å£°é“ï¼Œ24kHz
const channelData = audioBuffer.getChannelData(0)

// å°†PCM16è½¬æ¢ä¸ºFloat32ï¼ˆ-1åˆ°1èŒƒå›´ï¼‰
for (let i = 0; i < sampleCount; i++) {
  channelData[i] = pcm16Data[i] / 32768.0
}

// æ’­æ”¾éŸ³é¢‘
const source = audioContext.createBufferSource()
source.buffer = audioBuffer
source.connect(audioContext.destination)
source.start()
```

## ä¿®å¤çš„æ–‡ä»¶

### 1. `frontend/src/utils/errorHandler.ts`
- æ›´æ–°äº† `handleAudioPlayback` å‡½æ•°
- æ­£ç¡®å¤„ç†PCM16æ ¼å¼çš„éŸ³é¢‘æ•°æ®
- æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### 2. `test-simple-audio.html`
- æ·»åŠ äº†éŸ³é¢‘æ’­æ”¾æµ‹è¯•åŠŸèƒ½
- å®ç°äº†GPTéŸ³é¢‘å“åº”çš„æ­£ç¡®æ’­æ”¾æ–¹æ³•
- åŒ…å«äº†å®Œæ•´çš„æµ‹è¯•æµç¨‹

## æŠ€æœ¯ç»†èŠ‚

### GPT Realtime APIéŸ³é¢‘æ ¼å¼
- **æ ¼å¼**: PCM16 (16ä½æœ‰ç¬¦å·æ•´æ•°)
- **é‡‡æ ·ç‡**: 24,000 Hz
- **å£°é“**: å•å£°é“ (mono)
- **å­—èŠ‚åº**: å°ç«¯åº (little-endian)
- **ä¼ è¾“**: Base64ç¼–ç 

### PCM16åˆ°Float32è½¬æ¢
```javascript
// PCM16èŒƒå›´: -32768 åˆ° 32767
// Float32èŒƒå›´: -1.0 åˆ° 1.0
const floatSample = pcm16Sample / 32768.0
```

### Web Audio APIé›†æˆ
- åˆ›å»º24kHzé‡‡æ ·ç‡çš„AudioContext
- ä½¿ç”¨ `createBuffer()` åˆ›å»ºéŸ³é¢‘ç¼“å†²åŒº
- ç›´æ¥è®¾ç½®é€šé“æ•°æ®ï¼Œæ— éœ€è§£ç 

## æµ‹è¯•éªŒè¯

### æµ‹è¯•é¡µé¢åŠŸèƒ½
1. **ç®€åŒ–æµ‹è¯•é¡µé¢**: `http://localhost:3000/test-simple-audio.html`
   - åŒ…å«å®Œæ•´çš„æµ‹è¯•æµç¨‹
   - æ–°å¢éŸ³é¢‘æ’­æ”¾æµ‹è¯•åŠŸèƒ½
   - è‡ªåŠ¨å¤„ç†GPTéŸ³é¢‘å“åº”

2. **ä¸»è¦èŠå¤©ç•Œé¢**: `http://localhost:3000/realtime-chat`
   - ä¿®å¤äº†éŸ³é¢‘æ’­æ”¾é”™è¯¯
   - æ”¯æŒå®Œæ•´çš„è¯­éŸ³å¯¹è¯æµç¨‹

### é¢„æœŸæµ‹è¯•ç»“æœ
```
[æ—¶é—´] æ”¶åˆ°GPTéŸ³é¢‘å“åº”ï¼Œå¼€å§‹æ’­æ”¾...
[æ—¶é—´] æ’­æ”¾GPTéŸ³é¢‘: 48000 æ ·æœ¬, 2.00ç§’
[æ—¶é—´] âœ“ GPTéŸ³é¢‘æ’­æ”¾å®Œæˆ
```

## ç³»ç»ŸçŠ¶æ€

### åç«¯é›†æˆ âœ…
- GPT Realtime APIè¿æ¥æ­£å¸¸
- éŸ³é¢‘æ•°æ®ä¼ è¾“æˆåŠŸ
- å“åº”å¤„ç†å®Œæ•´

### å‰ç«¯ä¿®å¤ âœ…
- éŸ³é¢‘å½•åˆ¶åŠŸèƒ½æ­£å¸¸
- PCM16è½¬æ¢æ­£ç¡®
- éŸ³é¢‘æ’­æ”¾åŠŸèƒ½ä¿®å¤

### Dockeréƒ¨ç½² âœ…
- å‰ç«¯å®¹å™¨å·²é‡æ–°æ„å»º
- æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ
- é…ç½®æ›´æ–°å·²åº”ç”¨

## å®Œæ•´çš„è¯­éŸ³å¯¹è¯æµç¨‹

### 1. ç”¨æˆ·å½•éŸ³
- éº¦å…‹é£æ•è·éŸ³é¢‘ â†’ MediaRecorder/Web Audio API
- è½¬æ¢ä¸ºPCM16æ ¼å¼ â†’ Base64ç¼–ç 
- é€šè¿‡WebSocketå‘é€åˆ°åç«¯

### 2. åç«¯å¤„ç†
- æ¥æ”¶Base64éŸ³é¢‘æ•°æ® â†’ è§£ç ä¸ºPCM16
- è½¬å‘åˆ°GPT Realtime API
- æ¥æ”¶GPTçš„éŸ³é¢‘å“åº”

### 3. GPTå“åº”æ’­æ”¾ âœ… **å·²ä¿®å¤**
- æ¥æ”¶Base64ç¼–ç çš„PCM16æ•°æ®
- è§£ç ä¸ºåŸå§‹å­—èŠ‚æ•°ç»„
- è½¬æ¢ä¸ºFloat32éŸ³é¢‘ç¼“å†²åŒº
- é€šè¿‡Web Audio APIæ’­æ”¾

## æ€§èƒ½ä¼˜åŒ–

### éŸ³é¢‘å¤„ç†æ•ˆç‡
- **æ— éœ€è§£ç **: ç›´æ¥å¤„ç†PCM16æ•°æ®ï¼Œé¿å…è§£ç å¼€é”€
- **å†…å­˜æ•ˆç‡**: ä½¿ç”¨TypedArrayè¿›è¡Œé«˜æ•ˆæ•°æ®è½¬æ¢
- **ä½å»¶è¿Ÿ**: æœ€å°åŒ–éŸ³é¢‘å¤„ç†ç®¡é“

### é”™è¯¯å¤„ç†
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œç”¨æˆ·æç¤º
- ä¼˜é›…çš„é”™è¯¯æ¢å¤æœºåˆ¶
- å…¼å®¹æ€§fallbackæ–¹æ¡ˆ

## æ€»ç»“

ğŸ¯ **é—®é¢˜è§£å†³**: éŸ³é¢‘æ’­æ”¾é”™è¯¯å·²å®Œå…¨ä¿®å¤

ğŸ”§ **æŠ€æœ¯æˆæœ**:
- æ­£ç¡®å®ç°äº†PCM16éŸ³é¢‘æ•°æ®çš„æ’­æ”¾
- å»ºç«‹äº†å®Œæ•´çš„è¯­éŸ³å¯¹è¯ç®¡é“
- æä¾›äº†å…¨é¢çš„æµ‹è¯•å’ŒéªŒè¯å·¥å…·

ğŸš€ **ç”¨æˆ·ä½“éªŒ**:
- è¯­éŸ³å½•åˆ¶ âœ…
- éŸ³é¢‘å‘é€ âœ…  
- GPTå¤„ç† âœ…
- éŸ³é¢‘æ’­æ”¾ âœ… **æ–°ä¿®å¤**
- å®Œæ•´å¯¹è¯ âœ…

ç°åœ¨ç”¨æˆ·å¯ä»¥äº«å—å®Œæ•´çš„åŒå‘è¯­éŸ³å¯¹è¯ä½“éªŒï¼š
1. å½•åˆ¶è¯­éŸ³æ¶ˆæ¯å‘é€ç»™GPT
2. GPTå¤„ç†å¹¶ç”Ÿæˆè¯­éŸ³å›å¤
3. è‡ªåŠ¨æ’­æ”¾GPTçš„è¯­éŸ³å“åº”
4. å®ç°çœŸæ­£çš„å®æ—¶è¯­éŸ³äº¤äº’

**éŸ³é¢‘æ’­æ”¾é—®é¢˜ä¿®å¤å®Œæˆï¼** ğŸ‰