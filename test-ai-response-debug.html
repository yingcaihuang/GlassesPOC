<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå“åº”è°ƒè¯•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e9ecef;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>AIå“åº”è°ƒè¯•æµ‹è¯•</h1>
        <p>æµ‹è¯•AIæ˜¯å¦æ­£å¸¸å“åº”ç”¨æˆ·è¾“å…¥</p>
        
        <button onclick="testLogin()">1. ç™»å½•</button>
        <button onclick="testWebSocket()" disabled id="wsBtn">2. è¿æ¥WebSocket</button>
        <button onclick="testAudioResponse()" disabled id="audioBtn">3. æµ‹è¯•éŸ³é¢‘å“åº”</button>
        
        <div class="status" id="status">å‡†å¤‡å¼€å§‹æµ‹è¯•</div>
        
        <div>
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let token = null;
        let ws = null;
        let audioResponseReceived = false;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function setStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        async function testLogin() {
            try {
                log('ğŸ” å¼€å§‹ç™»å½•æµ‹è¯•...');
                setStatus('æ­£åœ¨ç™»å½•...', 'warning');
                
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'betty@123.com',
                        password: 'Betty@123.com'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    log('âœ… ç™»å½•æˆåŠŸ');
                    setStatus('ç™»å½•æˆåŠŸ', 'success');
                    document.getElementById('wsBtn').disabled = false;
                } else {
                    throw new Error(`ç™»å½•å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ ç™»å½•å¤±è´¥: ${error.message}`);
                setStatus('ç™»å½•å¤±è´¥', 'error');
            }
        }

        async function testWebSocket() {
            try {
                log('ğŸ”Œ å¼€å§‹WebSocketè¿æ¥æµ‹è¯•...');
                setStatus('æ­£åœ¨è¿æ¥WebSocket...', 'warning');
                
                const wsUrl = `ws://localhost:3000/api/v1/realtime/chat?token=${token}`;
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    setStatus('WebSocketå·²è¿æ¥', 'success');
                    document.getElementById('audioBtn').disabled = false;
                    
                    // å‘é€ä¼šè¯é…ç½®
                    const config = {
                        type: 'configure_session',
                        config: {
                            audio_format: 'pcm16',
                            sample_rate: 24000,
                            channels: 1
                        }
                    };
                    ws.send(JSON.stringify(config));
                    log('ğŸ“¤ å‘é€ä¼šè¯é…ç½®');
                };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    log(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${message.type}`);
                    
                    if (message.type === 'audio_response') {
                        audioResponseReceived = true;
                        log(`ğŸµ æ”¶åˆ°éŸ³é¢‘å“åº”: ${message.audio ? message.audio.length : 0} å­—ç¬¦`);
                        setStatus('æ”¶åˆ°AIéŸ³é¢‘å“åº”ï¼', 'success');
                        
                        // å°è¯•æ’­æ”¾éŸ³é¢‘
                        if (message.audio) {
                            playAudio(message.audio);
                        }
                    } else if (message.type === 'text_response') {
                        log(`ğŸ’¬ æ”¶åˆ°æ–‡æœ¬å“åº”: ${message.text}`);
                        setStatus('æ”¶åˆ°AIæ–‡æœ¬å“åº”ï¼', 'success');
                    } else if (message.type === 'error') {
                        log(`âŒ æ”¶åˆ°é”™è¯¯: ${JSON.stringify(message.error)}`);
                        setStatus('æ”¶åˆ°é”™è¯¯å“åº”', 'error');
                    } else {
                        log(`â„¹ï¸ å…¶ä»–æ¶ˆæ¯: ${JSON.stringify(message)}`);
                    }
                };
                
                ws.onerror = (error) => {
                    log(`âŒ WebSocketé”™è¯¯: ${error}`);
                    setStatus('WebSocketè¿æ¥é”™è¯¯', 'error');
                };
                
                ws.onclose = (event) => {
                    log(`ğŸ”Œ WebSocketè¿æ¥å…³é—­: ${event.code}`);
                    setStatus('WebSocketå·²æ–­å¼€', 'warning');
                };
                
            } catch (error) {
                log(`âŒ WebSocketè¿æ¥å¤±è´¥: ${error.message}`);
                setStatus('WebSocketè¿æ¥å¤±è´¥', 'error');
            }
        }

        async function testAudioResponse() {
            try {
                log('ğŸ¤ å¼€å§‹éŸ³é¢‘å“åº”æµ‹è¯•...');
                setStatus('å‘é€æµ‹è¯•éŸ³é¢‘...', 'warning');
                audioResponseReceived = false;
                
                // ç”Ÿæˆæµ‹è¯•éŸ³é¢‘æ•°æ®ï¼ˆ1ç§’çš„é™éŸ³ï¼ŒPCM16æ ¼å¼ï¼‰
                const sampleRate = 24000;
                const duration = 1; // 1ç§’
                const sampleCount = sampleRate * duration;
                
                // ç”ŸæˆPCM16æ•°æ®ï¼ˆé™éŸ³ï¼‰
                const pcm16Data = new Int16Array(sampleCount);
                for (let i = 0; i < sampleCount; i++) {
                    pcm16Data[i] = 0; // é™éŸ³
                }
                
                // è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
                const bytes = new Uint8Array(pcm16Data.length * 2);
                for (let i = 0; i < pcm16Data.length; i++) {
                    const value = pcm16Data[i];
                    bytes[i * 2] = value & 0xFF;
                    bytes[i * 2 + 1] = (value >> 8) & 0xFF;
                }
                
                // ç¼–ç ä¸ºBase64
                const blob = new Blob([bytes]);
                const reader = new FileReader();
                
                reader.onload = function() {
                    const result = reader.result;
                    if (typeof result === 'string') {
                        const base64Audio = result.split(',')[1];
                        
                        // å‘é€éŸ³é¢‘æ•°æ®
                        ws.send(JSON.stringify({
                            type: 'audio_data',
                            audio: base64Audio,
                            timestamp: Date.now()
                        }));
                        
                        log(`ğŸ“¤ å‘é€æµ‹è¯•éŸ³é¢‘: ${base64Audio.length} å­—ç¬¦`);
                        
                        // ç­‰å¾…5ç§’æ£€æŸ¥æ˜¯å¦æ”¶åˆ°å“åº”
                        setTimeout(() => {
                            if (audioResponseReceived) {
                                log('âœ… AIå“åº”æµ‹è¯•æˆåŠŸï¼');
                                setStatus('AIå“åº”æ­£å¸¸', 'success');
                            } else {
                                log('âš ï¸ 5ç§’å†…æœªæ”¶åˆ°AIå“åº”');
                                setStatus('AIå¯èƒ½æœªå“åº”', 'warning');
                            }
                        }, 5000);
                    }
                };
                
                reader.readAsDataURL(blob);
                
            } catch (error) {
                log(`âŒ éŸ³é¢‘å“åº”æµ‹è¯•å¤±è´¥: ${error.message}`);
                setStatus('æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        async function playAudio(audioData) {
            try {
                log('ğŸ”Š å°è¯•æ’­æ”¾AIéŸ³é¢‘å“åº”...');
                
                // è§£ç Base64æ•°æ®
                const binaryData = atob(audioData);
                const arrayBuffer = new ArrayBuffer(binaryData.length);
                const uint8Array = new Uint8Array(arrayBuffer);
                
                for (let i = 0; i < binaryData.length; i++) {
                    uint8Array[i] = binaryData.charCodeAt(i);
                }

                // åˆ›å»ºAudioContext
                const audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 24000
                });
                
                // è½¬æ¢PCM16åˆ°Float32
                const pcm16Data = new Int16Array(arrayBuffer);
                const sampleCount = pcm16Data.length;
                const audioBuffer = audioContext.createBuffer(1, sampleCount, 24000);
                const channelData = audioBuffer.getChannelData(0);
                
                for (let i = 0; i < sampleCount; i++) {
                    channelData[i] = pcm16Data[i] / 32768.0;
                }
                
                // æ’­æ”¾éŸ³é¢‘
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
                
                log(`âœ… éŸ³é¢‘æ’­æ”¾å¼€å§‹: ${sampleCount} æ ·æœ¬, ${audioBuffer.duration.toFixed(2)}ç§’`);
                
            } catch (error) {
                log(`âŒ éŸ³é¢‘æ’­æ”¾å¤±è´¥: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        log('ğŸ“± AIå“åº”è°ƒè¯•æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
        log('ğŸ’¡ æç¤ºï¼šæŒ‰é¡ºåºç‚¹å‡»æŒ‰é’®è¿›è¡Œæµ‹è¯•');
    </script>
</body>
</html>