<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptProcessor Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #e9ecef;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .audio-level {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .audio-level-bar {
            height: 100%;
            background: linear-gradient(to right, #28a745, #ffc107, #dc3545);
            width: 0%;
            transition: width 0.1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ScriptProcessor Debug Test</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ScriptProcessoræ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
        
        <button id="startBtn">å¼€å§‹æµ‹è¯•</button>
        <button id="stopBtn" disabled>åœæ­¢æµ‹è¯•</button>
        
        <div class="status" id="status">ç‚¹å‡»å¼€å§‹æµ‹è¯•æŒ‰é’®</div>
        
        <div>
            <h3>éŸ³é¢‘ç”µå¹³</h3>
            <div class="audio-level">
                <div class="audio-level-bar" id="audioLevelBar"></div>
            </div>
            <span id="audioLevelText">0%</span>
        </div>
        
        <div>
            <h3>è°ƒè¯•æ—¥å¿—</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        let audioContext = null;
        let mediaStream = null;
        let scriptProcessor = null;
        let analyser = null;
        let isRecording = false;
        let processCount = 0;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const log = document.getElementById('log');
        const audioLevelBar = document.getElementById('audioLevelBar');
        const audioLevelText = document.getElementById('audioLevelText');

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        async function startTest() {
            try {
                addLog('ğŸ¤ è¯·æ±‚éº¦å…‹é£æƒé™...');
                
                // è·å–éº¦å…‹é£æƒé™
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 24000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                addLog('âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸ');
                
                // åˆ›å»ºAudioContext
                audioContext = new AudioContext({
                    sampleRate: 24000,
                    latencyHint: 'interactive'
                });
                
                addLog(`ğŸµ AudioContextåˆ›å»ºæˆåŠŸï¼ŒçŠ¶æ€: ${audioContext.state}`);
                
                // å¦‚æœAudioContextè¢«æš‚åœï¼Œå°è¯•æ¢å¤
                if (audioContext.state === 'suspended') {
                    addLog('âš ï¸ AudioContextè¢«æš‚åœï¼Œå°è¯•æ¢å¤...');
                    await audioContext.resume();
                    addLog(`âœ… AudioContextæ¢å¤ï¼Œæ–°çŠ¶æ€: ${audioContext.state}`);
                }
                
                // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
                const source = audioContext.createMediaStreamSource(mediaStream);
                const gainNode = audioContext.createGain();
                analyser = audioContext.createAnalyser();
                scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
                
                addLog('ğŸ”— éŸ³é¢‘èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ');
                
                // è¿æ¥éŸ³é¢‘é“¾
                source.connect(gainNode);
                gainNode.connect(scriptProcessor);
                scriptProcessor.connect(analyser);
                analyser.connect(audioContext.destination);
                
                addLog('ğŸ”— éŸ³é¢‘é“¾è¿æ¥: source â†’ gain â†’ scriptProcessor â†’ analyser â†’ destination');
                
                // è®¾ç½®åˆ†æå™¨
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                
                // é‡ç½®è®¡æ•°å™¨
                processCount = 0;
                isRecording = true;
                
                // è®¾ç½®ScriptProcessorå›è°ƒ
                scriptProcessor.onaudioprocess = (event) => {
                    if (!isRecording) return;
                    
                    processCount++;
                    
                    const inputBuffer = event.inputBuffer;
                    const inputData = inputBuffer.getChannelData(0);
                    
                    // è®¡ç®—éŸ³é¢‘ç”µå¹³
                    let sum = 0;
                    for (let i = 0; i < inputData.length; i++) {
                        sum += Math.abs(inputData[i]);
                    }
                    const average = sum / inputData.length;
                    const level = Math.min(100, average * 1000); // æ”¾å¤§æ˜¾ç¤º
                    
                    // æ›´æ–°UI
                    audioLevelBar.style.width = `${level}%`;
                    audioLevelText.textContent = `${level.toFixed(1)}%`;
                    
                    // æ¯50æ¬¡å¤„ç†æ‰“å°ä¸€æ¬¡æ—¥å¿—
                    if (processCount % 50 === 0) {
                        addLog(`ğŸ¯ ScriptProcessorå¤„ç†: ç¬¬${processCount}æ¬¡, æ ·æœ¬æ•°: ${inputData.length}, éŸ³é¢‘ç”µå¹³: ${level.toFixed(2)}%`);
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³é¢‘ä¿¡å·
                    if (level > 1 && processCount % 10 === 0) {
                        addLog(`ğŸ”Š æ£€æµ‹åˆ°éŸ³é¢‘ä¿¡å·: ${level.toFixed(2)}%`);
                    }
                };
                
                addLog('âœ… ScriptProcessorå›è°ƒè®¾ç½®å®Œæˆ');
                addLog('ğŸ¤ å¼€å§‹å½•éŸ³æµ‹è¯•...');
                
                // æ›´æ–°UI
                startBtn.disabled = true;
                stopBtn.disabled = false;
                status.textContent = 'æ­£åœ¨å½•éŸ³æµ‹è¯•ä¸­...';
                
                // å¼€å§‹éŸ³é¢‘å¯è§†åŒ–
                startVisualization();
                
            } catch (error) {
                addLog(`âŒ é”™è¯¯: ${error.message}`);
                status.textContent = `é”™è¯¯: ${error.message}`;
            }
        }

        function stopTest() {
            isRecording = false;
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
                addLog('ğŸ›‘ åª’ä½“æµå·²åœæ­¢');
            }
            
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
                audioContext = null;
                addLog('ğŸ›‘ AudioContextå·²å…³é—­');
            }
            
            // é‡ç½®UI
            startBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = 'æµ‹è¯•å·²åœæ­¢';
            audioLevelBar.style.width = '0%';
            audioLevelText.textContent = '0%';
            
            addLog(`ğŸ“Š æµ‹è¯•å®Œæˆï¼Œæ€»å…±å¤„ç†äº† ${processCount} æ¬¡éŸ³é¢‘æ•°æ®`);
        }

        function startVisualization() {
            if (!analyser || !isRecording) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function draw() {
                if (!isRecording || !analyser) return;
                
                analyser.getByteFrequencyData(dataArray);
                
                // è®¡ç®—å¹³å‡éŸ³é¢‘ç”µå¹³
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                const level = (average / 255) * 100;
                
                // æ›´æ–°å¯è§†åŒ–ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œä¸»è¦ç”¨ScriptProcessorçš„æ•°æ®ï¼‰
                
                requestAnimationFrame(draw);
            }
            
            draw();
        }

        // äº‹ä»¶ç›‘å¬å™¨
        startBtn.addEventListener('click', startTest);
        stopBtn.addEventListener('click', stopTest);

        // é¡µé¢åŠ è½½å®Œæˆ
        addLog('ğŸ“± é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
        addLog('ğŸ’¡ æç¤ºï¼šè¯·ç¡®ä¿å…è®¸éº¦å…‹é£æƒé™ï¼Œå¹¶åœ¨å®‰é™ç¯å¢ƒä¸­æµ‹è¯•');
    </script>
</body>
</html>