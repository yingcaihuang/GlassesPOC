<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug Test</title>
</head>
<body>
    <h1>WebSocket Connection Debug</h1>
    <div id="status">Ready to test...</div>
    <button onclick="testConnection()">Test WebSocket</button>
    <div id="log" style="background: #f0f0f0; padding: 10px; margin: 10px 0; height: 400px; overflow-y: auto;"></div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function testConnection() {
            try {
                log('Starting WebSocket test...');
                updateStatus('Testing...');

                // First login
                log('1. Logging in...');
                const loginResponse = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'betty@123.com',
                        password: 'Betty@123.com'
                    })
                });

                if (!loginResponse.ok) {
                    throw new Error('Login failed');
                }

                const loginData = await loginResponse.json();
                const token = loginData.token;
                log('✓ Login successful');

                // Test WebSocket connection
                log('2. Connecting to WebSocket...');
                
                // Try different WebSocket URLs
                const wsUrls = [
                    `ws://${window.location.host}/api/v1/realtime/chat?token=${token}`,
                    `ws://localhost:8080/api/v1/realtime/chat?token=${token}`,
                    `ws://localhost:3000/api/v1/realtime/chat?token=${token}`
                ];

                for (let i = 0; i < wsUrls.length; i++) {
                    const wsUrl = wsUrls[i];
                    log(`Trying URL ${i+1}: ${wsUrl}`);
                    
                    try {
                        await testWebSocketUrl(wsUrl, i+1);
                        break; // If successful, stop trying other URLs
                    } catch (error) {
                        log(`✗ URL ${i+1} failed: ${error.message}`);
                    }
                }

            } catch (error) {
                log(`✗ Test failed: ${error.message}`);
                updateStatus('Test failed');
            }
        }

        function testWebSocketUrl(wsUrl, urlIndex) {
            return new Promise((resolve, reject) => {
                const ws = new WebSocket(wsUrl);
                let resolved = false;

                const timeout = setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        ws.close();
                        reject(new Error('Connection timeout'));
                    }
                }, 10000); // 10 second timeout

                ws.onopen = function() {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        log(`✓ WebSocket connected successfully with URL ${urlIndex}!`);
                        updateStatus('WebSocket connected!');

                        // Send test message
                        const testMsg = { type: 'test', message: 'Hello from browser!' };
                        ws.send(JSON.stringify(testMsg));
                        log('Sent test message: ' + JSON.stringify(testMsg));

                        // Close after 3 seconds
                        setTimeout(() => {
                            ws.close();
                            resolve();
                        }, 3000);
                    }
                };

                ws.onmessage = function(event) {
                    log('✓ Received: ' + event.data);
                };

                ws.onerror = function(error) {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        log(`✗ WebSocket error with URL ${urlIndex}: ${error}`);
                        reject(error);
                    }
                };

                ws.onclose = function(event) {
                    log(`WebSocket closed: code=${event.code}, reason=${event.reason || 'none'}`);
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timeout);
                        if (event.code !== 1000) {
                            reject(new Error(`Connection closed abnormally: ${event.code}`));
                        } else {
                            resolve();
                        }
                    }
                };
            });
        }
    </script>
</body>
</html>