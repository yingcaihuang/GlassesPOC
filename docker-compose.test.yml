# 测试环境配置 - 用于集成测试和CI/CD
services:
  # PostgreSQL Database for Testing
  postgres-test:
    image: postgres:15-alpine
    container_name: smart-glasses-postgres-test
    environment:
      POSTGRES_USER: smartglasses_test
      POSTGRES_PASSWORD: smartglasses_test_123
      POSTGRES_DB: smart_glasses_test
    ports:
      - "5433:5432"  # 使用不同端口避免冲突
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U smartglasses_test"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - smart-glasses-test-network
    tmpfs:
      - /var/lib/postgresql/data  # 使用内存存储提高测试速度

  # Redis Cache for Testing
  redis-test:
    image: redis:7-alpine
    container_name: smart-glasses-redis-test
    ports:
      - "6380:6379"  # 使用不同端口避免冲突
    volumes:
      - redis_test_data:/data
    command: redis-server --appendonly no --save ""  # 禁用持久化提高测试速度
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - smart-glasses-test-network

  # Backend Application for Testing
  app-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: smart-glasses-app-test
    environment:
      # Server
      SERVER_PORT: "8080"
      SERVER_ENV: "test"
      
      # Database (测试数据库)
      POSTGRES_DSN: "postgres://smartglasses_test:smartglasses_test_123@postgres-test:5432/smart_glasses_test?sslmode=disable"
      REDIS_ADDR: "redis-test:6379"
      REDIS_PASSWORD: ""
      
      # JWT (测试用密钥)
      JWT_SECRET_KEY: "test-secret-key-for-testing-only"
      JWT_ACCESS_TOKEN_EXPIRY: "1h"
      JWT_REFRESH_TOKEN_EXPIRY: "24h"
      
      # Azure OpenAI (测试配置)
      AZURE_OPENAI_ENDPOINT: "${AZURE_OPENAI_ENDPOINT:-https://test.openai.azure.com}"
      AZURE_OPENAI_API_KEY: "${AZURE_OPENAI_API_KEY:-test-api-key}"
      AZURE_OPENAI_DEPLOYMENT_NAME: "${AZURE_OPENAI_DEPLOYMENT_NAME:-gpt-4}"
      AZURE_OPENAI_API_VERSION: "${AZURE_OPENAI_API_VERSION:-2024-02-15-preview}"
      
      # Azure OpenAI Realtime API (测试配置)
      AZURE_OPENAI_REALTIME_ENDPOINT: "${AZURE_OPENAI_REALTIME_ENDPOINT:-https://test.cognitiveservices.azure.com}"
      AZURE_OPENAI_REALTIME_API_KEY: "${AZURE_OPENAI_REALTIME_API_KEY:-test-realtime-api-key}"
      AZURE_OPENAI_REALTIME_DEPLOYMENT_NAME: "${AZURE_OPENAI_REALTIME_DEPLOYMENT_NAME:-gpt-4o-realtime-preview}"
      AZURE_OPENAI_REALTIME_API_VERSION: "${AZURE_OPENAI_REALTIME_API_VERSION:-2024-10-01-preview}"
      
      # 测试特定配置
      LOG_LEVEL: "debug"
      ENABLE_CORS: "true"
      CORS_ORIGINS: "*"
    ports:
      - "8081:8080"  # 使用不同端口避免冲突
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy
    networks:
      - smart-glasses-test-network
    restart: "no"  # 测试环境不自动重启

  # Frontend Application for Testing
  frontend-test:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: smart-glasses-frontend-test
    ports:
      - "3001:80"  # 使用不同端口避免冲突
    environment:
      - NODE_ENV=test
      - REACT_APP_API_URL=http://app-test:8080
    depends_on:
      - app-test
    networks:
      - smart-glasses-test-network
    restart: "no"

  # 测试运行器 - 用于运行集成测试
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test  # 专门的测试镜像
    container_name: smart-glasses-test-runner
    environment:
      # 测试环境配置
      TEST_DATABASE_URL: "postgres://smartglasses_test:smartglasses_test_123@postgres-test:5432/smart_glasses_test?sslmode=disable"
      TEST_REDIS_URL: "redis://redis-test:6379"
      TEST_API_URL: "http://app-test:8080"
      TEST_FRONTEND_URL: "http://frontend-test:80"
      
      # Realtime API 测试配置
      TEST_REALTIME_ENDPOINT: "${AZURE_OPENAI_REALTIME_ENDPOINT:-https://test.cognitiveservices.azure.com}"
      TEST_REALTIME_API_KEY: "${AZURE_OPENAI_REALTIME_API_KEY:-test-realtime-api-key}"
      
      # 测试配置
      GO_TEST_TIMEOUT: "30m"
      TEST_PARALLEL: "4"
      TEST_VERBOSE: "true"
    volumes:
      - .:/app
      - /app/vendor  # 缓存依赖
    working_dir: /app
    depends_on:
      app-test:
        condition: service_started
      frontend-test:
        condition: service_started
    networks:
      - smart-glasses-test-network
    profiles:
      - test  # 只在测试时启动
    command: ["make", "test-integration"]  # 运行集成测试

volumes:
  postgres_test_data:
  redis_test_data:

networks:
  smart-glasses-test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16  # 使用不同的子网避免冲突

# 测试相关的配置
x-test-common: &test-common
  restart: "no"
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"

# 健康检查配置
x-healthcheck-fast: &healthcheck-fast
  interval: 5s
  timeout: 3s
  retries: 3
  start_period: 10s