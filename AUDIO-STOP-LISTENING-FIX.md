# åœæ­¢ç›‘å¬åæŒç»­æ’­æ”¾å’Œé”™è¯¯å¤„ç†ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆäº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. **åœæ­¢ç›‘å¬åæŒç»­æ’­æ”¾**: ç‚¹å‡»åœæ­¢ç›‘å¬æŒ‰é’®åï¼ŒGPTä»ä¼šæŒç»­æ’­æ”¾ä¸€æ®µæ—¶é—´çš„å›å¤
2. **æœªçŸ¥é”™è¯¯æ˜¾ç¤º**: ç•Œé¢å‡ºç°"å¤„ç†é”™è¯¯: æœªçŸ¥é”™è¯¯"çš„æç¤º

## é—®é¢˜åˆ†æ

### 1. åœæ­¢ç›‘å¬åæŒç»­æ’­æ”¾é—®é¢˜
**æ ¹æœ¬åŸå› **: 
- å‰ç«¯åœæ­¢ç›‘å¬æ—¶æ²¡æœ‰é€šçŸ¥åç«¯åœæ­¢å¤„ç†
- GPT APIå¯èƒ½è¿˜åœ¨å¤„ç†ä¹‹å‰å‘é€çš„éŸ³é¢‘æ•°æ®
- ç¼ºä¹ä¼šè¯çŠ¶æ€ç®¡ç†ï¼Œæ— æ³•åŒºåˆ†æ­£å¸¸å“åº”å’Œåœæ­¢åçš„å“åº”

### 2. æœªçŸ¥é”™è¯¯é—®é¢˜
**æ ¹æœ¬åŸå› **:
- WebSocketé”™è¯¯å¤„ç†ä¸­ï¼Œå½“`data.error`ä¸ºundefinedæ—¶ï¼Œ`JSON.stringify(undefined)`è¿”å›å­—ç¬¦ä¸²"undefined"
- åœæ­¢ç›‘å¬åçš„æ­£å¸¸GPTå“åº”è¢«å½“ä½œé”™è¯¯å¤„ç†

## ä¿®å¤æ–¹æ¡ˆ

### 1. å‰ç«¯ä¿®å¤ (frontend/src/pages/RealtimeChat.tsx)

#### æ·»åŠ ä¼šè¯çŠ¶æ€ç®¡ç†
```typescript
const [sessionActive, setSessionActive] = useState(false) // æ·»åŠ ä¼šè¯çŠ¶æ€ç®¡ç†
```

#### æ”¹è¿›åœæ­¢ç›‘å¬é€»è¾‘
```typescript
// å‘é€åœæ­¢ä¿¡å·ç»™åç«¯
if (websocketRef.current && websocketRef.current.readyState === WebSocket.OPEN) {
  websocketRef.current.send(JSON.stringify({
    type: 'stop_listening',
    timestamp: Date.now()
  }))
  console.log('å‘é€åœæ­¢ç›‘å¬ä¿¡å·ç»™åç«¯')
}
```

#### ä¼˜åŒ–WebSocketæ¶ˆæ¯å¤„ç†
```typescript
case 'audio_response':
  // åªæœ‰åœ¨ä¼šè¯æ´»è·ƒæ—¶æ‰å¤„ç†éŸ³é¢‘å“åº”
  if (sessionActive && data.audio) {
    playAudioResponse(data.audio)
  } else if (!sessionActive) {
    console.log('å¿½ç•¥åœæ­¢åçš„éŸ³é¢‘å“åº”')
  }
  break

case 'error':
  // åªæœ‰åœ¨ä¼šè¯æ´»è·ƒæ—¶æ‰æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…åœæ­¢åçš„æ­£å¸¸é”™è¯¯
  if (sessionActive) {
    const errorMessage = data.error ? 
      (typeof data.error === 'string' ? data.error : JSON.stringify(data.error)) : 
      'æœªçŸ¥é”™è¯¯'
    setError('å¤„ç†é”™è¯¯: ' + errorMessage)
    setIsProcessing(false)
    console.error('WebSocket error message:', data)
  } else {
    console.log('å¿½ç•¥åœæ­¢åçš„é”™è¯¯å“åº”:', data)
  }
  break
```

### 2. åç«¯ä¿®å¤ (internal/handler/realtime_handler.go)

#### æ·»åŠ åœæ­¢ç›‘å¬æ¶ˆæ¯å¤„ç†
```go
case "stop_listening":
  // å¤„ç†åœæ­¢ç›‘å¬ä¿¡å·
  log.Printf("Received stop_listening signal from user: %s", userID)
  
  // å‘é€åœæ­¢ä¿¡å·åˆ°GPT APIï¼ˆå¦‚æœæ”¯æŒçš„è¯ï¼‰
  stopMessage := map[string]interface{}{
    "type": "input_audio_buffer.cancel",
  }
  
  if err := gptConn.WriteJSON(stopMessage); err != nil {
    log.Printf("Failed to send stop signal to GPT API: %v", err)
  } else {
    log.Printf("Sent stop signal to GPT API for user: %s", userID)
  }
  
  // å›å¤ç¡®è®¤æ¶ˆæ¯
  response := map[string]interface{}{
    "type": "stop_confirmed",
    "timestamp": time.Now().Unix(),
    "message": "åœæ­¢ç›‘å¬ä¿¡å·å·²å¤„ç†",
  }
  err = conn.WriteJSON(response)
```

### 3. éŸ³é¢‘æ’­æ”¾ä¼˜åŒ– (frontend/src/utils/errorHandler.ts)

#### ä¿®å¤çˆ†ç ´éŸ³é—®é¢˜
- æ·»åŠ 10msæ·¡å…¥æ·¡å‡ºæ•ˆæœ
- åœ¨éŸ³é¢‘å¼€å¤´å’Œç»“å°¾æ·»åŠ 240ä¸ªæ ·æœ¬ï¼ˆ10msï¼‰çš„é™éŸ³å¡«å……
- æ·»åŠ 8kHzä½é€šæ»¤æ³¢å™¨å»é™¤é«˜é¢‘å™ªéŸ³

#### æ”¹è¿›é”™è¯¯å¤„ç†
- ä¿®å¤undefinedé”™è¯¯æ˜¾ç¤ºé—®é¢˜
- æ·»åŠ éŸ³é¢‘æ’­æ”¾é˜Ÿåˆ—ç®¡ç†
- ä½¿ç”¨å…¨å±€AudioContexté¿å…é‡å¤åˆ›å»º

## ä¿®å¤æ•ˆæœ

### âœ… å·²è§£å†³çš„é—®é¢˜

1. **åœæ­¢ç›‘å¬å“åº”**: 
   - å‰ç«¯å‘é€åœæ­¢ä¿¡å·ç»™åç«¯
   - åç«¯è½¬å‘åœæ­¢ä¿¡å·ç»™GPT API
   - ä¼šè¯çŠ¶æ€ç®¡ç†ç¡®ä¿åœæ­¢åä¸å¤„ç†å“åº”

2. **é”™è¯¯å¤„ç†ä¼˜åŒ–**:
   - ä¿®å¤"å¤„ç†é”™è¯¯: undefined"é—®é¢˜
   - åœæ­¢åçš„æ­£å¸¸å“åº”ä¸å†æ˜¾ç¤ºä¸ºé”™è¯¯
   - æ›´å¥½çš„é”™è¯¯ä¿¡æ¯æ˜¾ç¤º

3. **éŸ³é¢‘è´¨é‡æ”¹è¿›**:
   - æ¶ˆé™¤éŸ³é¢‘åœé¡¿æ—¶çš„çˆ†ç ´éŸ³
   - æ›´æµç•…çš„éŸ³é¢‘æ’­æ”¾ä½“éªŒ
   - æ›´å¥½çš„éŸ³é¢‘èµ„æºç®¡ç†

### ğŸ”§ æŠ€æœ¯æ”¹è¿›

1. **ä¼šè¯çŠ¶æ€ç®¡ç†**: åŒºåˆ†æ´»è·ƒä¼šè¯å’Œåœæ­¢çŠ¶æ€
2. **ä¿¡å·é€šä¿¡**: å‰åç«¯åè°ƒå¤„ç†åœæ­¢ä¿¡å·
3. **é”™è¯¯å¤„ç†**: æ›´ç²¾ç¡®çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
4. **éŸ³é¢‘ä¼˜åŒ–**: æ·¡å…¥æ·¡å‡ºã€é™éŸ³å¡«å……ã€æ»¤æ³¢å™¨

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶
- `test-audio-pop-fix.html` - éŸ³é¢‘çˆ†ç ´éŸ³ä¿®å¤æµ‹è¯•
- `test-audio-playback-smooth.html` - éŸ³é¢‘æ’­æ”¾æµç•…æ€§æµ‹è¯•

### æµ‹è¯•åœºæ™¯
1. âœ… æ­£å¸¸å¼€å§‹å’Œåœæ­¢ç›‘å¬
2. âœ… åœæ­¢ç›‘å¬åä¸å†æ’­æ”¾GPTå“åº”
3. âœ… é”™è¯¯ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
4. âœ… éŸ³é¢‘æ’­æ”¾æ— çˆ†ç ´éŸ³
5. âœ… è¿ç»­å¯¹è¯æµç•…åˆ‡æ¢

## éƒ¨ç½²è¯´æ˜

### å‰ç«¯æ„å»º
```bash
cd frontend && npm run build
```

### åç«¯æ„å»º
```bash
docker-compose build
```

### å¯åŠ¨æœåŠ¡
```bash
docker-compose up -d
```

## æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†ç”¨æˆ·ä½“éªŒä¸­çš„å…³é”®é—®é¢˜ï¼š
- **åœæ­¢ç›‘å¬ç«‹å³ç”Ÿæ•ˆ**: ä¸å†æœ‰å»¶è¿Ÿæ’­æ”¾
- **é”™è¯¯ä¿¡æ¯å‡†ç¡®**: æ¶ˆé™¤è¯¯å¯¼æ€§çš„é”™è¯¯æç¤º
- **éŸ³é¢‘è´¨é‡æå‡**: æ¶ˆé™¤çˆ†ç ´éŸ³ï¼Œæ’­æ”¾æ›´æµç•…
- **ç³»ç»Ÿç¨³å®šæ€§**: æ›´å¥½çš„çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†

ä¿®å¤åçš„ç³»ç»Ÿæä¾›äº†æ›´å¥½çš„å®æ—¶è¯­éŸ³å¯¹è¯ä½“éªŒï¼Œç¬¦åˆGPT Realtime APIçš„é¢„æœŸä½¿ç”¨æ¨¡å¼ã€‚